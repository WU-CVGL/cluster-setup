worker_processes 16;
 
events { worker_connections 1024; }

http {
    # top-level http config for websocket headers
    # If Upgrade is defined, Connection = upgrade
    # If Upgrade is empty, Connection = close
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    sendfile on;

    # disable any limits to avoid HTTP 413 for large image uploads
    client_max_body_size 0;
 
    upstream frp {
        # server 10.0.1.68:7500;
        server 192.168.233.8:7500;
    }

    upstream peng {
        server 10.0.1.69:5000;
    }

    upstream flare {
        # server 10.0.1.68:5005;
        server 192.168.233.8:5005;
    }

    upstream determined {
        # server 10.0.1.66:8080;
        server 192.168.233.6:8080;
    }

    upstream wandb {
        # server 10.0.1.68:8081;
        server 192.168.233.8:8081;
    }

    upstream nextcloud {
        # server 10.0.1.68:8008;
        server 192.168.233.8:8008;
    }

    upstream gitea {
        # server 10.0.1.68:3000;
        server 192.168.233.8:3000;
    }

    upstream portainer {
        # server 10.0.1.68:9000;
        server 192.168.233.8:9000;
    }
 
    upstream harbor {
        # server 10.0.1.68:50000;
        server 192.168.233.8:50000;
    }

    upstream grafana {
        # server 10.0.1.68:10080;
        server 192.168.233.8:10080;
    }


    server {
        listen 80;
        server_name cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location ^~ /cvgl.crt {
            alias /usr/share/nginx/html/cvgl.crt;
        }

        location / {
            proxy_pass http://flare;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name frp.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  frp.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location ^~ /cvgl.crt {
            alias /usr/share/nginx/html/cvgl.crt;
        }

        location / {
            proxy_pass http://frp;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen       443 ssl;
        server_name  peng.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;

        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location ^~ /cvgl.crt {
            alias /usr/share/nginx/html/cvgl.crt;
        }

        location / {
            proxy_pass http://peng;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name wandb.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  wandb.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # required to avoid HTTP 411: see Issue #1486 (https://github.com/moby/moby/issues/1486)
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://wandb;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
            client_max_body_size 0;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_request_buffering off;
            proxy_max_temp_file_size 0;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name pan.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  pan.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # required to avoid HTTP 411: see Issue #1486 (https://github.com/moby/moby/issues/1486)
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://nextcloud;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
            client_max_body_size 0;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_request_buffering off;
            proxy_max_temp_file_size 0;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name gpu.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  gpu.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # required to avoid HTTP 411: see Issue #1486 (https://github.com/moby/moby/issues/1486)
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://determined;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # websocket headers
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header X-Scheme $scheme;

            proxy_buffering off;

        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name git.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  git.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # required to avoid HTTP 411: see Issue #1486 (https://github.com/moby/moby/issues/1486)
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://gitea;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name portainer.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  portainer.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # required to avoid HTTP 411: see Issue #1486 (https://github.com/moby/moby/issues/1486)
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://portainer;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name harbor.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  harbor.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # required to avoid HTTP 411: see Issue #1486 (https://github.com/moby/moby/issues/1486)
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://harbor;
            proxy_redirect     off;
            proxy_set_header   Host $server_name;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host "";
            # avoid "unknown blob error" (https://github.com/goharbor/harbor/issues/6187)
            # and "unauthorized: authentication required" (https://github.com/distribution/distribution/issues/1177)
            proxy_set_header   X-Forwarded-Proto https;
            # https://serverfault.com/questions/768693/nginx-how-to-completely-disable-request-body-buffering
            client_max_body_size 0;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_request_buffering off;
            proxy_max_temp_file_size 0;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    server {
        listen 80;
        server_name grafana.cvgl.lab;

        # Tell all requests to port 80 to be 302 redirected to HTTPS
        return 302 https://$host$request_uri;
    }

    server {
        listen       443 ssl;
        server_name  grafana.cvgl.lab;

        #access_log  /var/log/nginx/host.access.log  main;
        
        ssl_certificate /opt/ssl/Server.cer;
        ssl_certificate_key /opt/ssl/Server-unsecure.pvk;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # required to avoid HTTP 411: see Issue #1486 (https://github.com/moby/moby/issues/1486)
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://grafana;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }
}

stream {
    upstream determined {
        server 10.0.1.66:8080;
    }

    server {
        listen 8080;
        proxy_pass determined;
    }
}
